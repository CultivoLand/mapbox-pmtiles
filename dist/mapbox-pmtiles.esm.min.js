"use strict";var w=function(n,t,e,o){function i(s){return s instanceof e?s:new e(function(a){a(s)})}return new(e||(e=Promise))(function(s,a){function r(c){try{d(o.next(c))}catch(l){a(l)}}function u(c){try{d(o.throw(c))}catch(l){a(l)}}function d(c){c.done?s(c.value):i(c.value).then(r,u)}d((o=o.apply(n,t||[])).next())})},v;import M from"mapbox-gl";import{PMTiles as x,Protocol as z}from"pmtiles";const S=Style.getSourceType("vector");export const SOURCE_TYPE="pmtile-source";const _=(n,...t)=>{for(const e of t)for(const o in e)n[o]=e[o];return n},T=n=>(180+n)/360,y=n=>(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+n*Math.PI/360)))/360;class b{constructor(t,e,o){this.bounds=M.LngLatBounds.convert(this.validateBounds(t)),this.minzoom=e||0,this.maxzoom=o||24}validateBounds(t){return!Array.isArray(t)||t.length!==4?[-180,-90,180,90]:[Math.max(-180,t[0]),Math.max(-90,t[1]),Math.min(180,t[2]),Math.min(90,t[3])]}contains(t){const e=Math.pow(2,t.z),o={minX:Math.floor(T(this.bounds.getWest())*e),minY:Math.floor(y(this.bounds.getNorth())*e),maxX:Math.ceil(T(this.bounds.getEast())*e),maxY:Math.ceil(y(this.bounds.getSouth())*e)};return t.x>=o.minX&&t.x<o.maxX&&t.y>=o.minY&&t.y<o.maxY}}class f{constructor(t,e={}){_(this,e),this.type=t}}class g extends f{constructor(t,e={}){super("error",_({error:t},e))}}export const PmTilesSource=(v=class extends S{static getMetadata(t){return w(this,void 0,void 0,function*(){return new x(t).getMetadata()})}constructor(...t){var e;super(...t),this.roundZoom=!0,this.type="vector",this._collectResourceTiming=!1;const[o,i,s,a]=t;this.id=o,this._dataType="vector",this.dispatcher=s,this._implementation=i;const{url:r}=i;this.setEventedParent(a),this.reparseOverscaled=!0,this.scheme="zxy",this.tileSize=512,this._loaded=!1,this.type="vector",this._protocol=new z,this.tiles=[`pmtiles://${r}/{z}/{x}/{y}`];const u=new x(r);this._protocol.add(u),this._instance=u,this._implementation||(e=this.fire)===null||e===void 0||e.call(new g(new Error(`Missing implementation for ${this.id} custom source`)))}hasTile(t){return!this.tileBounds||this.tileBounds.contains(t.canonical)}load(t){var e;this._loaded=!1,(e=this.fire)===null||e===void 0||e.call(new f("dataloading",{dataType:"source"})),this._tileJSONRequest=this._instance.getMetadata().then(o=>{var i,s;this._tileJSONRequest=void 0,this._loaded=!0,_(this,o),o.bounds&&o.minZoom&&o.m&&(this.tileBounds=new b(o.bounds,this.minzoom,this.maxzoom)),this.maxzoom==null&&console.warn("The maxzoom parameter is not defined in the source json. This can cause memory leak. So make sure to define maxzoom in the layer"),this.type="vector",(i=this.fire)===null||i===void 0||i.call(new f("data",{dataType:"source",sourceDataType:"metadata"})),(s=this.fire)===null||s===void 0||s.call(new f("data",{dataType:"source",sourceDataType:"content"}))}).catch(o=>{var i;(i=this.fire)===null||i===void 0||i.call(new g(o)),t&&t(o)})}loaded(){return this._loaded}loadTile(t,e){var o,i,s;const a=(l,h)=>{var m,p;if(delete t.request,t.aborted)return e(null);if(l&&l.status!==404)return e(l);h&&h.resourceTiming&&(t.resourceTiming=h.resourceTiming),!((m=this.map)===null||m===void 0)&&m._refreshExpiredTiles&&h&&t.setExpiryData(h),t.loadVectorData(h,(p=this.map)===null||p===void 0?void 0:p.painter),e(null),t.reloadCallback&&(this.loadTile(t,t.reloadCallback),t.reloadCallback=null)},r=(o=this.map)===null||o===void 0?void 0:o._requestManager.normalizeTileURL(t.tileID.canonical.url(this.tiles,this.scheme)),d={request:(i=this.map)===null||i===void 0?void 0:i._requestManager.transformRequest(r,"Tile"),data:{},uid:t.uid,tileID:t.tileID,tileZoom:t.tileZoom,zoom:t.tileID.overscaledZ,tileSize:this.tileSize*t.tileID.overscaleFactor(),type:"vector",source:this.id,scope:this.scope,showCollisionBoxes:(s=this.map)===null||s===void 0?void 0:s.showCollisionBoxes,promoteId:this.promoteId,isSymbolTile:t.isSymbolTile,extraShadowCaster:t.isExtraShadowCaster},c=(l,h,m,p)=>{if(l||!h){a.call(this,l);return}if(h.length==0){a.call(this,new Error("zero size data"));return}d.data={cacheControl:m,expires:p,rawData:h},t.actor&&t.actor.send("loadTile",d,a.bind(this),void 0,!0)};if(t.tileZoom<this.minzoom||t.tileZoom>=this.maxzoom-1)return e({status:404});if(!t.actor||t.state==="expired")t.actor=this._tileWorkers[r]=this._tileWorkers[r]||this.dispatcher.getActor(),t.request=this._protocol.tile(Object.assign(Object.assign({},t),{url:r}),c);else if(t.state==="loading")t.reloadCallback=e;else{debugger;t.request=this._protocol.tile(Object.assign(Object.assign({},t),{url:r}),c)}console.log(r)}},v.SOURCE_TYPE=SOURCE_TYPE,v);Style.setSourceType(PmTilesSource.SOURCE_TYPE,PmTilesSource);export default PmTilesSource;
