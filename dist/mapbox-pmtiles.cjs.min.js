"use strict";var __awaiter=function(s,t,e,o){function i(r){return r instanceof e?r:new e(function(n){n(r)})}return new(e||(e=Promise))(function(r,n){function a(c){try{h(o.next(c))}catch(l){n(l)}}function d(c){try{h(o.throw(c))}catch(l){n(l)}}function h(c){c.done?r(c.value):i(c.value).then(a,d)}h((o=o.apply(s,t||[])).next())})},__importDefault=function(s){return s&&s.__esModule?s:{default:s}},_a;Object.defineProperty(exports,"__esModule",{value:!0}),exports.PmTilesSource=exports.SOURCE_TYPE=void 0;const mapbox_gl_1=__importDefault(require("mapbox-gl")),pmtiles_1=require("pmtiles"),VectorTileSourceImpl=mapbox_gl_1.default.Style.getSourceType("vector");exports.SOURCE_TYPE="pmtile-source";const extend=(s,...t)=>{for(const e of t)for(const o in e)s[o]=e[o];return s},mercatorXFromLng=s=>(180+s)/360,mercatorYFromLat=s=>(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+s*Math.PI/360)))/360;class TileBounds{constructor(t,e,o){this.bounds=mapbox_gl_1.default.LngLatBounds.convert(this.validateBounds(t)),this.minzoom=e||0,this.maxzoom=o||24}validateBounds(t){return!Array.isArray(t)||t.length!==4?[-180,-90,180,90]:[Math.max(-180,t[0]),Math.max(-90,t[1]),Math.min(180,t[2]),Math.min(90,t[3])]}contains(t){const e=Math.pow(2,t.z),o={minX:Math.floor(mercatorXFromLng(this.bounds.getWest())*e),minY:Math.floor(mercatorYFromLat(this.bounds.getNorth())*e),maxX:Math.ceil(mercatorXFromLng(this.bounds.getEast())*e),maxY:Math.ceil(mercatorYFromLat(this.bounds.getSouth())*e)};return t.x>=o.minX&&t.x<o.maxX&&t.y>=o.minY&&t.y<o.maxY}}class Event{constructor(t,e={}){extend(this,e),this.type=t}}class ErrorEvent extends Event{constructor(t,e={}){super("error",extend({error:t},e))}}exports.PmTilesSource=(_a=class extends VectorTileSourceImpl{static getMetadata(t){return __awaiter(this,void 0,void 0,function*(){return new pmtiles_1.PMTiles(t).getMetadata()})}constructor(...t){var e;super(...t),this.roundZoom=!0,this.type="vector",this._collectResourceTiming=!1;const[o,i,r,n]=t;this.id=o,this._dataType="vector",this.dispatcher=r,this._implementation=i;const{url:a}=i;this.setEventedParent(n),this.reparseOverscaled=!0,this.scheme="zxy",this.tileSize=512,this._loaded=!1,this.type="vector",this._protocol=new pmtiles_1.Protocol,this.tiles=[`pmtiles://${a}/{z}/{x}/{y}`];const d=new pmtiles_1.PMTiles(a);this._protocol.add(d),this._instance=d,this._implementation||(e=this.fire)===null||e===void 0||e.call(new ErrorEvent(new Error(`Missing implementation for ${this.id} custom source`)))}hasTile(t){return!this.tileBounds||this.tileBounds.contains(t.canonical)}load(t){var e;this._loaded=!1,(e=this.fire)===null||e===void 0||e.call(new Event("dataloading",{dataType:"source"})),this._tileJSONRequest=this._instance.getMetadata().then(o=>{var i,r;this._tileJSONRequest=void 0,this._loaded=!0,extend(this,o),o.bounds&&o.minZoom&&o.m&&(this.tileBounds=new TileBounds(o.bounds,this.minzoom,this.maxzoom)),this.maxzoom==null&&console.warn("The maxzoom parameter is not defined in the source json. This can cause memory leak. So make sure to define maxzoom in the layer"),this.type="vector",(i=this.fire)===null||i===void 0||i.call(new Event("data",{dataType:"source",sourceDataType:"metadata"})),(r=this.fire)===null||r===void 0||r.call(new Event("data",{dataType:"source",sourceDataType:"content"}))}).catch(o=>{var i;(i=this.fire)===null||i===void 0||i.call(new ErrorEvent(o)),t&&t(o)})}loaded(){return this._loaded}loadTile(t,e){var o,i,r;const n=(l,u)=>{var m,p;if(delete t.request,t.aborted)return e(null);if(l&&l.status!==404)return e(l);u&&u.resourceTiming&&(t.resourceTiming=u.resourceTiming),!((m=this.map)===null||m===void 0)&&m._refreshExpiredTiles&&u&&t.setExpiryData(u),t.loadVectorData(u,(p=this.map)===null||p===void 0?void 0:p.painter),e(null),t.reloadCallback&&(this.loadTile(t,t.reloadCallback),t.reloadCallback=null)},a=(o=this.map)===null||o===void 0?void 0:o._requestManager.normalizeTileURL(t.tileID.canonical.url(this.tiles,this.scheme)),h={request:(i=this.map)===null||i===void 0?void 0:i._requestManager.transformRequest(a,"Tile"),data:{},uid:t.uid,tileID:t.tileID,tileZoom:t.tileZoom,zoom:t.tileID.overscaledZ,tileSize:this.tileSize*t.tileID.overscaleFactor(),type:"vector",source:this.id,scope:this.scope,showCollisionBoxes:(r=this.map)===null||r===void 0?void 0:r.showCollisionBoxes,promoteId:this.promoteId,isSymbolTile:t.isSymbolTile,extraShadowCaster:t.isExtraShadowCaster},c=(l,u,m,p)=>{if(l||!u){n.call(this,l);return}if(u.length==0){n.call(this,new Error("zero size data"));return}h.data={cacheControl:m,expires:p,rawData:u},t.actor&&t.actor.send("loadTile",h,n.bind(this),void 0,!0)};if(t.tileZoom<this.minzoom||t.tileZoom>=this.maxzoom-1)return e({status:404});if(!t.actor||t.state==="expired")t.actor=this._tileWorkers[a]=this._tileWorkers[a]||this.dispatcher.getActor(),t.request=this._protocol.tile(Object.assign(Object.assign({},t),{url:a}),c);else if(t.state==="loading")t.reloadCallback=e;else{debugger;t.request=this._protocol.tile(Object.assign(Object.assign({},t),{url:a}),c)}console.log(a)}},_a.SOURCE_TYPE=exports.SOURCE_TYPE,_a),mapbox_gl_1.default.Style.setSourceType(exports.PmTilesSource.SOURCE_TYPE,exports.PmTilesSource),exports.default=exports.PmTilesSource;
