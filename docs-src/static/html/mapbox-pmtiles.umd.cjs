(function(E,z){typeof exports=="object"&&typeof module<"u"?z(exports,require("mapbox-gl")):typeof define=="function"&&define.amd?define(["exports","mapbox-gl"],z):(E=typeof globalThis<"u"?globalThis:E||self,z(E.mapboxPmTiles={},E.mapboxgl))})(this,function(E,z){"use strict";var C=Math.pow,p=(t,e,r)=>new Promise((n,i)=>{var o=h=>{try{c(r.next(h))}catch(l){i(l)}},s=h=>{try{c(r.throw(h))}catch(l){i(l)}},c=h=>h.done?n(h.value):Promise.resolve(h.value).then(o,s);c((r=r.apply(t,e)).next())}),y=Uint8Array,S=Uint16Array,Re=Int32Array,ue=new y([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),he=new y([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),Ie=new y([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),fe=function(t,e){for(var r=new S(31),n=0;n<31;++n)r[n]=e+=1<<t[n-1];for(var i=new Re(r[30]),n=1;n<30;++n)for(var o=r[n];o<r[n+1];++o)i[o]=o-r[n]<<5|n;return{b:r,r:i}},de=fe(ue,2),me=de.b,He=de.r;me[28]=258,He[258]=28;var $e=fe(he,0),ke=$e.b,Y=new S(32768);for(d=0;d<32768;++d)b=(d&43690)>>1|(d&21845)<<1,b=(b&52428)>>2|(b&13107)<<2,b=(b&61680)>>4|(b&3855)<<4,Y[d]=((b&65280)>>8|(b&255)<<8)>>1;var b,d,P=function(t,e,r){for(var n=t.length,i=0,o=new S(e);i<n;++i)t[i]&&++o[t[i]-1];var s=new S(e);for(i=1;i<e;++i)s[i]=s[i-1]+o[i-1]<<1;var c;if(r){c=new S(1<<e);var h=15-e;for(i=0;i<n;++i)if(t[i])for(var l=i<<4|t[i],a=e-t[i],u=s[t[i]-1]++<<a,f=u|(1<<a)-1;u<=f;++u)c[Y[u]>>h]=l}else for(c=new S(n),i=0;i<n;++i)t[i]&&(c[i]=Y[s[t[i]-1]++]>>15-t[i]);return c},Z=new y(288);for(d=0;d<144;++d)Z[d]=8;var d;for(d=144;d<256;++d)Z[d]=9;var d;for(d=256;d<280;++d)Z[d]=7;var d;for(d=280;d<288;++d)Z[d]=8;var d,ge=new y(32);for(d=0;d<32;++d)ge[d]=5;var d,qe=P(Z,9,1),Ke=P(ge,5,1),J=function(t){for(var e=t[0],r=1;r<t.length;++r)t[r]>e&&(e=t[r]);return e},T=function(t,e,r){var n=e/8|0;return(t[n]|t[n+1]<<8)>>(e&7)&r},F=function(t,e){var r=e/8|0;return(t[r]|t[r+1]<<8|t[r+2]<<16)>>(e&7)},je=function(t){return(t+7)/8|0},We=function(t,e,r){(e==null||e<0)&&(e=0),(r==null||r>t.length)&&(r=t.length);var n=new y(r-e);return n.set(t.subarray(e,r)),n},Ye=["unexpected EOF","invalid block type","invalid length/literal","invalid distance","stream finished","no stream handler",,"no callback","invalid UTF-8 data","extra field too long","date not in range 1980-2099","filename too long","stream finishing","invalid zip data"],w=function(t,e,r){var n=new Error(e||Ye[t]);if(n.code=t,Error.captureStackTrace&&Error.captureStackTrace(n,w),!r)throw n;return n},N=function(t,e,r,n){var i=t.length,o=n?n.length:0;if(!i||e.f&&!e.l)return r||new y(0);var s=!r||e.i!=2,c=e.i;r||(r=new y(i*3));var h=function(Pe){var Ze=r.length;if(Pe>Ze){var Oe=new y(Math.max(Ze*2,Pe));Oe.set(r),r=Oe}},l=e.f||0,a=e.p||0,u=e.b||0,f=e.l,m=e.d,g=e.m,x=e.n,A=i*8;do{if(!f){l=T(t,a,1);var j=T(t,a+1,3);if(a+=3,j)if(j==1)f=qe,m=Ke,g=9,x=5;else if(j==2){var ie=T(t,a,31)+257,ze=T(t,a+10,15)+4,Ce=ie+T(t,a+5,31)+1;a+=14;for(var I=new y(Ce),oe=new y(19),D=0;D<ze;++D)oe[Ie[D]]=T(t,a+D*3,7);a+=ze*3;for(var Se=J(oe),bt=(1<<Se)-1,Mt=P(oe,Se,1),D=0;D<Ce;){var _e=Mt[T(t,a,bt)];a+=_e&15;var v=_e>>4;if(v<16)I[D++]=v;else{var B=0,W=0;for(v==16?(W=3+T(t,a,3),a+=2,B=I[D-1]):v==17?(W=3+T(t,a,7),a+=3):v==18&&(W=11+T(t,a,127),a+=7);W--;)I[D++]=B}}var Ae=I.subarray(0,ie),U=I.subarray(ie);g=J(Ae),x=J(U),f=P(Ae,g,1),m=P(U,x,1)}else w(1);else{var v=je(a)+4,re=t[v-4]|t[v-3]<<8,ne=v+re;if(ne>i){c&&w(0);break}s&&h(u+re),r.set(t.subarray(v,ne),u),e.b=u+=re,e.p=a=ne*8,e.f=l;continue}if(a>A){c&&w(0);break}}s&&h(u+131072);for(var zt=(1<<g)-1,Ct=(1<<x)-1,se=a;;se=a){var B=f[F(t,a)&zt],V=B>>4;if(a+=B&15,a>A){c&&w(0);break}if(B||w(2),V<256)r[u++]=V;else if(V==256){se=a,f=null;break}else{var Be=V-254;if(V>264){var D=V-257,H=ue[D];Be=T(t,a,(1<<H)-1)+me[D],a+=H}var ae=m[F(t,a)&Ct],ce=ae>>4;ae||w(3),a+=ae&15;var U=ke[ce];if(ce>3){var H=he[ce];U+=F(t,a)&(1<<H)-1,a+=H}if(a>A){c&&w(0);break}s&&h(u+131072);var le=u+Be;if(u<U){var Ve=o-U,St=Math.min(U,le);for(Ve+u<0&&w(3);u<St;++u)r[u]=n[Ve+u]}for(;u<le;u+=4)r[u]=r[u-U],r[u+1]=r[u+1-U],r[u+2]=r[u+2-U],r[u+3]=r[u+3-U];u=le}}e.l=f,e.p=se,e.b=u,e.f=l,f&&(l=1,e.m=g,e.d=m,e.n=x)}while(!l);return u==r.length?r:We(r,0,u)},Je=new y(0),Fe=function(t){(t[0]!=31||t[1]!=139||t[2]!=8)&&w(6,"invalid gzip data");var e=t[3],r=10;e&4&&(r+=(t[10]|t[11]<<8)+2);for(var n=(e>>3&1)+(e>>4&1);n>0;n-=!t[r++]);return r+(e&2)},Ne=function(t){var e=t.length;return(t[e-4]|t[e-3]<<8|t[e-2]<<16|t[e-1]<<24)>>>0},Xe=function(t,e){return((t[0]&15)!=8||t[0]>>4>7||(t[0]<<8|t[1])%31)&&w(6,"invalid zlib data"),(t[1]>>5&1)==+!e&&w(6,"invalid zlib data: "+(t[1]&32?"need":"unexpected")+" dictionary"),(t[1]>>3&4)+2};function Ge(t,e){return N(t,{i:2},e&&e.out,e&&e.dictionary)}function Qe(t,e){var r=Fe(t);return r+8>t.length&&w(6,"invalid gzip data"),N(t.subarray(r,-8),{i:2},e&&e.out||new y(Ne(t)),e&&e.dictionary)}function et(t,e){return N(t.subarray(Xe(t,e&&e.dictionary),-4),{i:2},e&&e.out,e&&e.dictionary)}function X(t,e){return t[0]==31&&t[1]==139&&t[2]==8?Qe(t,e):(t[0]&15)!=8||t[0]>>4>7||(t[0]<<8|t[1])%31?Ge(t,e):et(t,e)}var tt=typeof TextDecoder<"u"&&new TextDecoder,rt=0;try{tt.decode(Je,{stream:!0}),rt=1}catch{}var ve=(t,e)=>t*C(2,e),O=(t,e)=>Math.floor(t/C(2,e)),$=(t,e)=>ve(t.getUint16(e+1,!0),8)+t.getUint8(e),pe=(t,e)=>ve(t.getUint32(e+2,!0),16)+t.getUint16(e,!0),nt=(t,e,r,n,i)=>{if(t!==n.getUint8(i))return t-n.getUint8(i);const o=$(n,i+1);if(e!==o)return e-o;const s=$(n,i+4);return r!==s?r-s:0},it=(t,e,r,n)=>{const i=we(t,e|128,r,n);return i?{z:e,x:r,y:n,offset:i[0],length:i[1],isDir:!0}:null},ye=(t,e,r,n)=>{const i=we(t,e,r,n);return i?{z:e,x:r,y:n,offset:i[0],length:i[1],isDir:!1}:null},we=(t,e,r,n)=>{let i=0,o=t.byteLength/17-1;for(;i<=o;){const s=o+i>>1,c=nt(e,r,n,t,s*17);if(c>0)i=s+1;else if(c<0)o=s-1;else return[pe(t,s*17+7),t.getUint32(s*17+13,!0)]}return null},ot=(t,e)=>t.isDir&&!e.isDir?1:!t.isDir&&e.isDir?-1:t.z!==e.z?t.z-e.z:t.x!==e.x?t.x-e.x:t.y-e.y,xe=(t,e)=>{const r=t.getUint8(e*17);return{z:r&127,x:$(t,e*17+1),y:$(t,e*17+4),offset:pe(t,e*17+7),length:t.getUint32(e*17+13,!0),isDir:r>>7===1}},De=t=>{const e=[],r=new DataView(t);for(let n=0;n<r.byteLength/17;n++)e.push(xe(r,n));return st(e)},st=t=>{t.sort(ot);const e=new ArrayBuffer(17*t.length),r=new Uint8Array(e);for(let n=0;n<t.length;n++){const i=t[n];let o=i.z;i.isDir&&(o=o|128),r[n*17]=o,r[n*17+1]=i.x&255,r[n*17+2]=i.x>>8&255,r[n*17+3]=i.x>>16&255,r[n*17+4]=i.y&255,r[n*17+5]=i.y>>8&255,r[n*17+6]=i.y>>16&255,r[n*17+7]=i.offset&255,r[n*17+8]=O(i.offset,8)&255,r[n*17+9]=O(i.offset,16)&255,r[n*17+10]=O(i.offset,24)&255,r[n*17+11]=O(i.offset,32)&255,r[n*17+12]=O(i.offset,48)&255,r[n*17+13]=i.length&255,r[n*17+14]=i.length>>8&255,r[n*17+15]=i.length>>16&255,r[n*17+16]=i.length>>24&255}return e},at=(t,e)=>{if(t.byteLength<17)return null;const r=t.byteLength/17,n=xe(t,r-1);if(n.isDir){const i=n.z,o=e.z-i,s=Math.trunc(e.x/(1<<o)),c=Math.trunc(e.y/(1<<o));return{z:i,x:s,y:c}}return null};function ct(t){return p(this,null,function*(){const e=yield t.getBytes(0,512e3),r=new DataView(e.data),n=r.getUint32(4,!0),i=r.getUint16(8,!0),o=new TextDecoder("utf-8"),s=JSON.parse(o.decode(new DataView(e.data,10,n)));let c=0;s.compression==="gzip"&&(c=2);let h=0;"minzoom"in s&&(h=+s.minzoom);let l=0;"maxzoom"in s&&(l=+s.maxzoom);let a=0,u=0,f=0,m=-180,g=-85,x=180,A=85;if(s.bounds){const v=s.bounds.split(",");m=+v[0],g=+v[1],x=+v[2],A=+v[3]}if(s.center){const v=s.center.split(",");a=+v[0],u=+v[1],f=+v[2]}return{specVersion:r.getUint16(2,!0),rootDirectoryOffset:10+n,rootDirectoryLength:i*17,jsonMetadataOffset:10,jsonMetadataLength:n,leafDirectoryOffset:0,leafDirectoryLength:void 0,tileDataOffset:0,tileDataLength:void 0,numAddressedTiles:0,numTileEntries:0,numTileContents:0,clustered:!1,internalCompression:1,tileCompression:c,tileType:1,minZoom:h,maxZoom:l,minLon:m,minLat:g,maxLon:x,maxLat:A,centerZoom:f,centerLon:a,centerLat:u,etag:e.etag}})}function lt(t,e,r,n,i,o,s){return p(this,null,function*(){let c=yield r.getArrayBuffer(e,t.rootDirectoryOffset,t.rootDirectoryLength,t);t.specVersion===1&&(c=De(c));const h=ye(new DataView(c),n,i,o);if(h){let u=(yield e.getBytes(h.offset,h.length,s)).data;const f=new DataView(u);return f.getUint8(0)===31&&f.getUint8(1)===139&&(u=X(new Uint8Array(u))),{data:u}}const l=at(new DataView(c),{z:n,x:i,y:o});if(l){const a=it(new DataView(c),l.z,l.x,l.y);if(a){let u=yield r.getArrayBuffer(e,a.offset,a.length,t);t.specVersion===1&&(u=De(u));const f=ye(new DataView(u),n,i,o);if(f){let g=(yield e.getBytes(f.offset,f.length,s)).data;const x=new DataView(g);return x.getUint8(0)===31&&x.getUint8(1)===139&&(g=X(new Uint8Array(g))),{data:g}}}}})}var Te={getHeader:ct,getZxy:lt},ut=t=>(e,r)=>{if(r instanceof AbortController)return t(e,r);const n=new AbortController;return t(e,n).then(i=>r(void 0,i.data,i.cacheControl||"",i.expires||""),i=>r(i)).catch(i=>r(i)),{cancel:()=>n.abort()}},ht=class{constructor(){this.tilev4=(t,e)=>p(this,null,function*(){if(t.type==="json"){const u=t.url.substr(10);let f=this.tiles.get(u);f||(f=new k(u),this.tiles.set(u,f));const m=yield f.getHeader();return{data:{tiles:[`${t.url}/{z}/{x}/{y}`],minzoom:m.minZoom,maxzoom:m.maxZoom,bounds:[m.minLon,m.minLat,m.maxLon,m.maxLat]}}}const r=new RegExp(/pmtiles:\/\/(.+)\/(\d+)\/(\d+)\/(\d+)/),n=t.url.match(r);if(!n)throw new Error("Invalid PMTiles protocol URL");const i=n[1];let o=this.tiles.get(i);o||(o=new k(i),this.tiles.set(i,o));const s=n[2],c=n[3],h=n[4],l=yield o.getHeader(),a=yield o==null?void 0:o.getZxy(+s,+c,+h,e.signal);return a?{data:new Uint8Array(a.data),cacheControl:a.cacheControl,expires:a.expires}:l.tileType===1?{data:new Uint8Array}:{data:null}}),this.tile=ut(this.tilev4),this.tiles=new Map}add(t){this.tiles.set(t.source.getKey(),t)}get(t){return this.tiles.get(t)}};function _(t,e){return(e>>>0)*4294967296+(t>>>0)}function ft(t,e){const r=e.buf;let n=r[e.pos++],i=(n&112)>>4;if(n<128||(n=r[e.pos++],i|=(n&127)<<3,n<128)||(n=r[e.pos++],i|=(n&127)<<10,n<128)||(n=r[e.pos++],i|=(n&127)<<17,n<128)||(n=r[e.pos++],i|=(n&127)<<24,n<128)||(n=r[e.pos++],i|=(n&1)<<31,n<128))return _(t,i);throw new Error("Expected varint not more than 10 bytes")}function R(t){const e=t.buf;let r=e[t.pos++],n=r&127;return r<128||(r=e[t.pos++],n|=(r&127)<<7,r<128)||(r=e[t.pos++],n|=(r&127)<<14,r<128)||(r=e[t.pos++],n|=(r&127)<<21,r<128)?n:(r=e[t.pos],n|=(r&15)<<28,ft(n,t))}function dt(t,e,r,n){if(n===0){r===1&&(e[0]=t-1-e[0],e[1]=t-1-e[1]);const i=e[0];e[0]=e[1],e[1]=i}}var mt=[0,1,5,21,85,341,1365,5461,21845,87381,349525,1398101,5592405,22369621,89478485,357913941,1431655765,5726623061,22906492245,91625968981,366503875925,1466015503701,5864062014805,23456248059221,93824992236885,375299968947541,0x5555555555555];function gt(t,e,r){if(t>26)throw Error("Tile zoom level exceeds max safe number limit (26)");if(e>C(2,t)-1||r>C(2,t)-1)throw Error("tile x/y outside zoom level bounds");const n=mt[t],i=C(2,t);let o=0,s=0,c=0;const h=[e,r];let l=i/2;for(;l>0;)o=(h[0]&l)>0?1:0,s=(h[1]&l)>0?1:0,c+=l*l*(3*o^s),dt(l,h,o,s),l=l/2;return n+c}function Le(t,e){return p(this,null,function*(){if(e===1||e===0)return t;if(e===2){if(typeof globalThis.DecompressionStream>"u")return X(new Uint8Array(t));const r=new Response(t).body;if(!r)throw Error("Failed to read response stream");const n=r.pipeThrough(new globalThis.DecompressionStream("gzip"));return new Response(n).arrayBuffer()}throw Error("Compression method not supported")})}var M=(t=>(t[t.Unknown=0]="Unknown",t[t.Mvt=1]="Mvt",t[t.Png=2]="Png",t[t.Jpeg=3]="Jpeg",t[t.Webp=4]="Webp",t[t.Avif=5]="Avif",t))(M||{}),vt=127;function pt(t,e){let r=0,n=t.length-1;for(;r<=n;){const i=n+r>>1,o=e-t[i].tileId;if(o>0)r=i+1;else if(o<0)n=i-1;else return t[i]}return n>=0&&(t[n].runLength===0||e-t[n].tileId<t[n].runLength)?t[n]:null}var yt=class{constructor(t,e=new Headers){this.url=t,this.customHeaders=e,this.mustReload=!1}getKey(){return this.url}setHeaders(t){this.customHeaders=t}getBytes(t,e,r,n){return p(this,null,function*(){let i,o;r?o=r:(i=new AbortController,o=i.signal);const s=new Headers(this.customHeaders);s.set("range",`bytes=${t}-${t+e-1}`);let c;this.mustReload&&(c="reload");let h=yield fetch(this.url,{signal:o,cache:c,headers:s});if(t===0&&h.status===416){const f=h.headers.get("Content-Range");if(!f||!f.startsWith("bytes */"))throw Error("Missing content-length on 416 response");const m=+f.substr(8);h=yield fetch(this.url,{signal:o,cache:"reload",headers:{range:`bytes=0-${m-1}`}})}let l=h.headers.get("Etag");if(l!=null&&l.startsWith("W/")&&(l=null),h.status===416||n&&l&&l!==n)throw this.mustReload=!0,new G(n);if(h.status>=300)throw Error(`Bad response code: ${h.status}`);const a=h.headers.get("Content-Length");if(h.status===200&&(!a||+a>e))throw i&&i.abort(),Error("Server returned no content-length header or content-length exceeding request. Check that your storage backend supports HTTP Byte Serving.");return{data:yield h.arrayBuffer(),etag:l||void 0,cacheControl:h.headers.get("Cache-Control")||void 0,expires:h.headers.get("Expires")||void 0}})}};function L(t,e){const r=t.getUint32(e+4,!0),n=t.getUint32(e+0,!0);return r*C(2,32)+n}function wt(t,e){const r=new DataView(t),n=r.getUint8(7);if(n>3)throw Error(`Archive is spec version ${n} but this library supports up to spec version 3`);return{specVersion:n,rootDirectoryOffset:L(r,8),rootDirectoryLength:L(r,16),jsonMetadataOffset:L(r,24),jsonMetadataLength:L(r,32),leafDirectoryOffset:L(r,40),leafDirectoryLength:L(r,48),tileDataOffset:L(r,56),tileDataLength:L(r,64),numAddressedTiles:L(r,72),numTileEntries:L(r,80),numTileContents:L(r,88),clustered:r.getUint8(96)===1,internalCompression:r.getUint8(97),tileCompression:r.getUint8(98),tileType:r.getUint8(99),minZoom:r.getUint8(100),maxZoom:r.getUint8(101),minLon:r.getInt32(102,!0)/1e7,minLat:r.getInt32(106,!0)/1e7,maxLon:r.getInt32(110,!0)/1e7,maxLat:r.getInt32(114,!0)/1e7,centerZoom:r.getUint8(118),centerLon:r.getInt32(119,!0)/1e7,centerLat:r.getInt32(123,!0)/1e7,etag:e}}function Ue(t){const e={buf:new Uint8Array(t),pos:0},r=R(e),n=[];let i=0;for(let o=0;o<r;o++){const s=R(e);n.push({tileId:i+s,offset:0,length:0,runLength:1}),i+=s}for(let o=0;o<r;o++)n[o].runLength=R(e);for(let o=0;o<r;o++)n[o].length=R(e);for(let o=0;o<r;o++){const s=R(e);s===0&&o>0?n[o].offset=n[o-1].offset+n[o-1].length:n[o].offset=s-1}return n}function xt(t){const e=new DataView(t);return e.getUint16(2,!0)===2?(console.warn("PMTiles spec version 2 has been deprecated; please see github.com/protomaps/PMTiles for tools to upgrade"),2):e.getUint16(2,!0)===1?(console.warn("PMTiles spec version 1 has been deprecated; please see github.com/protomaps/PMTiles for tools to upgrade"),1):3}var G=class extends Error{};function Dt(t,e){return p(this,null,function*(){const r=yield t.getBytes(0,16384);if(new DataView(r.data).getUint16(0,!0)!==19792)throw new Error("Wrong magic number for PMTiles archive");if(xt(r.data)<3)return[yield Te.getHeader(t)];const i=r.data.slice(0,vt),o=wt(i,r.etag),s=r.data.slice(o.rootDirectoryOffset,o.rootDirectoryOffset+o.rootDirectoryLength),c=`${t.getKey()}|${o.etag||""}|${o.rootDirectoryOffset}|${o.rootDirectoryLength}`,h=Ue(yield e(s,o.internalCompression));return[o,[c,h.length,h]]})}function Tt(t,e,r,n,i){return p(this,null,function*(){const o=yield t.getBytes(r,n,void 0,i.etag),s=yield e(o.data,i.internalCompression),c=Ue(s);if(c.length===0)throw new Error("Empty directory is invalid");return c})}var Lt=class{constructor(t=100,e=!0,r=Le){this.cache=new Map,this.invalidations=new Map,this.maxCacheEntries=t,this.counter=1,this.decompress=r}getHeader(t){return p(this,null,function*(){const e=t.getKey(),r=this.cache.get(e);if(r)return r.lastUsed=this.counter++,yield r.data;const n=new Promise((i,o)=>{Dt(t,this.decompress).then(s=>{s[1]&&this.cache.set(s[1][0],{lastUsed:this.counter++,data:Promise.resolve(s[1][2])}),i(s[0]),this.prune()}).catch(s=>{o(s)})});return this.cache.set(e,{lastUsed:this.counter++,data:n}),n})}getDirectory(t,e,r,n){return p(this,null,function*(){const i=`${t.getKey()}|${n.etag||""}|${e}|${r}`,o=this.cache.get(i);if(o)return o.lastUsed=this.counter++,yield o.data;const s=new Promise((c,h)=>{Tt(t,this.decompress,e,r,n).then(l=>{c(l),this.prune()}).catch(l=>{h(l)})});return this.cache.set(i,{lastUsed:this.counter++,data:s}),s})}getArrayBuffer(t,e,r,n){return p(this,null,function*(){const i=`${t.getKey()}|${n.etag||""}|${e}|${r}`,o=this.cache.get(i);if(o)return o.lastUsed=this.counter++,yield o.data;const s=new Promise((c,h)=>{t.getBytes(e,r,void 0,n.etag).then(l=>{c(l.data),this.cache.has(i),this.prune()}).catch(l=>{h(l)})});return this.cache.set(i,{lastUsed:this.counter++,data:s}),s})}prune(){if(this.cache.size>=this.maxCacheEntries){let t=1/0,e;this.cache.forEach((r,n)=>{r.lastUsed<t&&(t=r.lastUsed,e=n)}),e&&this.cache.delete(e)}}invalidate(t){return p(this,null,function*(){const e=t.getKey();if(this.invalidations.get(e))return yield this.invalidations.get(e);this.cache.delete(t.getKey());const r=new Promise((n,i)=>{this.getHeader(t).then(o=>{n(),this.invalidations.delete(e)}).catch(o=>{i(o)})});this.invalidations.set(e,r)})}},k=class{constructor(t,e,r){typeof t=="string"?this.source=new yt(t):this.source=t,r?this.decompress=r:this.decompress=Le,e?this.cache=e:this.cache=new Lt}getHeader(){return p(this,null,function*(){return yield this.cache.getHeader(this.source)})}getZxyAttempt(t,e,r,n){return p(this,null,function*(){const i=gt(t,e,r),o=yield this.cache.getHeader(this.source);if(o.specVersion<3)return Te.getZxy(o,this.source,this.cache,t,e,r,n);if(t<o.minZoom||t>o.maxZoom)return;let s=o.rootDirectoryOffset,c=o.rootDirectoryLength;for(let h=0;h<=3;h++){const l=yield this.cache.getDirectory(this.source,s,c,o),a=pt(l,i);if(a){if(a.runLength>0){const u=yield this.source.getBytes(o.tileDataOffset+a.offset,a.length,n,o.etag);return{data:yield this.decompress(u.data,o.tileCompression),cacheControl:u.cacheControl,expires:u.expires}}s=o.leafDirectoryOffset+a.offset,c=a.length}else return}throw Error("Maximum directory depth exceeded")})}getZxy(t,e,r,n){return p(this,null,function*(){try{return yield this.getZxyAttempt(t,e,r,n)}catch(i){if(i instanceof G)return this.cache.invalidate(this.source),yield this.getZxyAttempt(t,e,r,n);throw i}})}getMetadataAttempt(){return p(this,null,function*(){const t=yield this.cache.getHeader(this.source),e=yield this.source.getBytes(t.jsonMetadataOffset,t.jsonMetadataLength,void 0,t.etag),r=yield this.decompress(e.data,t.internalCompression),n=new TextDecoder("utf-8");return JSON.parse(n.decode(r))})}getMetadata(){return p(this,null,function*(){try{return yield this.getMetadataAttempt()}catch(t){if(t instanceof G)return this.cache.invalidate(this.source),yield this.getMetadataAttempt();throw t}})}};const Ut=z.Style.getSourceType("vector"),Ee="pmtile-source",Q=(t,...e)=>{for(const r of e)for(const n in r)t[n]=r[n];return t},be=t=>(180+t)/360,Me=t=>(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+t*Math.PI/360)))/360;class Et{constructor(e,r,n){this.bounds=z.LngLatBounds.convert(this.validateBounds(e)),this.minzoom=r||0,this.maxzoom=n||24}validateBounds(e){return!Array.isArray(e)||e.length!==4?[-180,-90,180,90]:[Math.max(-180,e[0]),Math.max(-90,e[1]),Math.min(180,e[2]),Math.min(90,e[3])]}contains(e){const r=Math.pow(2,e.z),n={minX:Math.floor(be(this.bounds.getWest())*r),minY:Math.floor(Me(this.bounds.getNorth())*r),maxX:Math.ceil(be(this.bounds.getEast())*r),maxY:Math.ceil(Me(this.bounds.getSouth())*r)};return e.x>=n.minX&&e.x<n.maxX&&e.y>=n.minY&&e.y<n.maxY}}class q{constructor(e,r={}){Q(this,r),this.type=e}}class ee extends q{constructor(e,r={}){super("error",Q({error:e},r))}}const te=class te extends Ut{constructor(...e){super(...e),this.roundZoom=!0,this.type="vector";const[r,n,i,o]=e;this.id=r,this._dataType="vector",this.dispatcher=i,this._implementation=n,this._implementation||this.fire(new ee(new Error(`Missing implementation for ${this.id} custom source`)));const{url:s}=n;this.reparseOverscaled=!0,this.scheme="zxy",this.tileSize=512,this._loaded=!1,this.type="vector",this._protocol=new ht,this.tiles=[`pmtiles://${s}/{z}/{x}/{y}`];const c=new k(s);this._protocol.add(c),this._instance=c}static async getMetadata(e){return new k(e).getMetadata()}zoomToExtent(){const{minZoom:e,maxZoom:r,minLon:n,minLat:i,maxLon:o,maxLat:s,centerZoom:c,centerLon:h,centerLat:l}=this.header;e!=null&&r!=null&&n!=null&&i!=null&&o!=null&&s!=null&&this.map.fitBounds([l,h],{maxZoom:c})}hasTile(e){return!this.tileBounds||this.tileBounds.contains(e.canonical)}load(e){this._loaded=!1,this.fire(new q("dataloading",{dataType:"source"})),this._tileJSONRequest=Promise.all([this._instance.getHeader(),this._instance.getMetadata()]).then(([r,n])=>{this.header=r;const{specVersion:i,clustered:o,tileType:s,minZoom:c,maxZoom:h,minLon:l,minLat:a,maxLon:u,maxLat:f,centerZoom:m,centerLon:g,centerLat:x}=r;switch(c!=null&&h!=null&&l!=null&&a!=null&&u!=null&&f!=null&&(this.tileBounds=new Et([l,a,u,f],c,h),this.minzoom=c,this.maxzoom=h),this.maxzoom==null&&console.warn("The maxzoom parameter is not defined in the source json. This can cause memory leak. So make sure to define maxzoom in the layer"),this._tileJSONRequest=void 0,this._loaded=!0,Q(this,n),this.tileType=s,s){case M.Png:this.contentType="image/png";break;case M.Jpeg:this.contentType="image/jpeg";break;case M.Webp:this.contentType="image/webp";break;case M.Avif:this.contentType="image/avif";break}[M.Jpeg,M.Png].includes(this.tileType)?(this.loadTile=this.loadRasterTile,this.type="raster"):this.tileType===M.Mvt?(this.loadTile=this.loadVectorTile,this.type="vector"):this.fire(new ee(new Error("Unsupported Tile Type"))),this.fire(new q("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new q("data",{dataType:"source",sourceDataType:"content"}))}).catch(r=>{this.fire(new ee(r)),e&&e(r)})}loaded(){return this._loaded}loadVectorTile(e,r){var h,l,a;const n=(u,f)=>{var m,g;if(delete e.request,e.aborted)return r(null);if(u&&u.status!==404)return r(u);f&&f.resourceTiming&&(e.resourceTiming=f.resourceTiming),(m=this.map)!=null&&m._refreshExpiredTiles&&f&&e.setExpiryData(f),e.loadVectorData(f,(g=this.map)==null?void 0:g.painter),r(null),e.reloadCallback&&(this.loadVectorTile(e,e.reloadCallback),e.reloadCallback=null)},i=(h=this.map)==null?void 0:h._requestManager.normalizeTileURL(e.tileID.canonical.url(this.tiles,this.scheme)),o=(l=this.map)==null?void 0:l._requestManager.transformRequest(i,"Tile"),s={request:o,data:{},uid:e.uid,tileID:e.tileID,tileZoom:e.tileZoom,zoom:e.tileID.overscaledZ,tileSize:this.tileSize*e.tileID.overscaleFactor(),type:"vector",source:this.id,scope:this.scope,showCollisionBoxes:(a=this.map)==null?void 0:a.showCollisionBoxes,promoteId:this.promoteId,isSymbolTile:e.isSymbolTile,extraShadowCaster:e.isExtraShadowCaster},c=(u,f,m,g)=>{if(u||!f){n.call(this,u);return}s.data={cacheControl:m,expires:g,rawData:f},this.map._refreshExpiredTiles&&e.setExpiryData({cacheControl:m,expires:g}),e.actor&&e.actor.send("loadTile",s,n.bind(this),void 0,!0)};!e.actor||e.state==="expired"?(e.actor=this._tileWorkers[i]=this._tileWorkers[i]||this.dispatcher.getActor(),e.request=this._protocol.tile({...o},c)):e.state==="loading"?e.reloadCallback=r:e.request=this._protocol.tile({...e,url:i},c)}loadRasterTileData(e,r){e.setTexture(r,this.map.painter)}loadRasterTile(e,r){var c,h;const n=({data:l,cacheControl:a,expires:u})=>{if(delete e.request,e.aborted)return r(null);if(l==null){const m={width:this.tileSize,height:this.tileSize,data:null};return this.loadRasterTileData(e,m),e.state="loaded",r(null)}l&&l.resourceTiming&&(e.resourceTiming=l.resourceTiming),this.map._refreshExpiredTiles&&e.setExpiryData({cacheControl:a,expires:u});const f=new window.Blob([new Uint8Array(l)],{type:"image/png"});window.createImageBitmap(f).then(m=>{this.loadRasterTileData(e,m),e.state="loaded",r(null)}).catch(m=>(e.state="errored",r(new Error(`Can't infer data type for ${this.id}, only raster data supported at the moment. ${m}`))))},i=(c=this.map)==null?void 0:c._requestManager.normalizeTileURL(e.tileID.canonical.url(this.tiles,this.scheme)),o=(h=this.map)==null?void 0:h._requestManager.transformRequest(i,"Tile"),s=new AbortController;e.request={cancel:()=>s.abort()},this._protocol.tile(o,s).then(n.bind(this)).catch(l=>{l.code!==20&&(e.state="errored",r(l))})}};te.SOURCE_TYPE=Ee;let K=te;E.PmTilesSource=K,E.SOURCE_TYPE=Ee,E.default=K,Object.defineProperties(E,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
